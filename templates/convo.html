<!-- # Mojia & Harshita
# final project
# draft version
# Dec 3, 2017 -->
<!-- !!!!! this page is not completed implemented yet! We will update the UI -->
<!-- this page shows the user a list of questions and allow the user to select what questions to answer
we will inplement audio file system to record the answers -->
{% extends "layout_2.html" %}

{% block content %}
<script>
var count = 0
</script>
	<div class='container' id='convo'>
			<div class="row">
			  <div class="col-lg-12 text-center">
			    <h4 class="section-heading"></h4>
			  </div>
			</div>
		<br><br>
		<audio class="text-center" id="player" controls></audio>
		<br>
		<button type='submit' value ='Next' class="btn btn-primary" id='next'>Next</button>

		<form method = "POST" action = "{{script}}" style='display:none'>
				<button type='submit' value ='Next' class="btn btn-primary" id='end'>End Conversation</button>
		</form>

	</div>

	<script>
        //initiate MediaRecorder with a MediaStream
        var recordedChunks = [];

        var recLength = 0,
              recBuffersL = [],
              recBuffersR = [];

		var questions = {{questions | safe}};
		var index = 0;
		var convoId = 0;
		$('h4').text(questions[index]);
		$('#next').click(function(){
			index++;
			$('h4').text(questions[index]);
			if (index === questions.length) {
				$('#end').attr('type', 'submit');
				$('#next').attr('style', 'display:none');
				$('form').attr('style', 'display:block');
                mediaRecorder.stop();
                download()

			}
		});

		var player = document.getElementById('player');

		var handleSuccess = function(stream) {

            //acquire access to microphone
		    if (window.URL) {
		      player.src = window.URL.createObjectURL(stream);
		    } else {
		      player.src = stream;
		    }

            //access raw data from microphone
            var context = new AudioContext();
            var source = context.createMediaStreamSource(stream);

            // create a ScriptProcessorNode
            if(!context.createScriptProcessor){
               node = context.createJavaScriptNode(4096, 2, 2);
            } else {
               node = context.createScriptProcessor(4096, 2, 2);
            }

            // listen to the audio data, and record into the buffer
            node.onaudioprocess = function(e){
              recBuffersL.push(e.inputBuffer.getChannelData(0));
              recBuffersR.push(e.inputBuffer.getChannelData(1));
              recLength += e.inputBuffer.getChannelData(0).length;
            }

            // connect the ScriptProcessorNode with the input audio
            source.connect(node);
            // if the ScriptProcessorNode is not connected to an output the "onaudioprocess" event is not triggered in chrome
            node.connect(context.destination);

            var options = {mimeType: 'video/webm;codecs=vp9'};
            mediaRecorder = new MediaRecorder(stream, options);
            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.start();
		  };

		navigator.mediaDevices.getUserMedia({ audio: true, video: false })
		      .then(handleSuccess);


        function handleDataAvailable(event) {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
            recBuffersL.push(e.inputBuffer.getChannelData(0));
            recBuffersR.push(e.inputBuffer.getChannelData(1));
          }
        }

        function play() {
          var superBuffer = new Blob(recordedChunks);
          videoElement.src =
            window.URL.createObjectURL(superBuffer);
        }

        function download() {
          var blob = new Blob(recordedChunks, {
            type: 'video/webm'
          });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          document.body.appendChild(a);
          a.style = 'display: none';
          a.href = url;
          a.download = 'convo.webm';
          a.click();
          window.URL.revokeObjectURL(url);
        } 

		// var handleSuccess = function(stream) {
		//     var context = new AudioContext();
		//     var source = context.createMediaStreamSource(stream);
		//     var processor = context.createScriptProcessor(1024, 1, 1);
		//
		//     source.connect(processor);
		//     processor.connect(context.destination);
		//
		//     processor.onaudioprocess = function(e) {
		//       // Do something with the data, i.e Convert this to WAV
		//       // console.log(e.inputBuffer);
		// 			stream = new mediaStream();
		// 			track = stream.getAudioTracks()
		// 			console.log(track)
		//     };
		//   };
		//
		//   navigator.mediaDevices.getUserMedia({ audio: true, video: false })
		//       .then(handleSuccess);

	</script>

{% endblock %}
