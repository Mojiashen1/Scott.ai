<!-- # Mojia & Harshita
# final project
# draft version
# Dec 3, 2017 -->
<!-- !!!!! this page is not completed implemented yet! We will update the UI -->
<!-- this page shows the user a list of questions and allow the user to select what questions to answer
we will inplement audio file system to record the answers -->
{% extends "layout_2.html" %}

{% block content %}
<script>
var count = 0
</script>
	<div class='container' id='convo'>
			<div class="row">
			  <div class="col-lg-12 text-center">
			    <h4 class="section-heading"></h4>
			  </div>
			</div>
		<br><br>
		<audio class="text-center" id="player" controls></audio>
		<br>
		<button type='submit' value ='Next' class="btn btn-primary" id='next'>Next</button>

		<form method = "POST" action = "{{script}}" style='display:none'>
				<button type='submit' value ='Next' class="btn btn-primary" id='end'>End Conversation</button>
		</form>

	</div>

	<script>
        //initiate MediaRecorder with a MediaStream
        var recordedChunks = [];

        var recLength =  0,
              recBuffersL = [],
              recBuffersR = [];

        //populate all questions
		var questions = {{questions | safe}};
		var index = 0;
		var convoId = 0;
		$('h4').text(questions[index]);
		$('#next').click(function(){
			index++;
			$('h4').text(questions[index]);
			if (index === questions.length) {
				$('#end').attr('type', 'submit');
				$('#next').attr('style', 'display:none');
				$('form').attr('style', 'display:block');
                mediaRecorder.stop();
                download()

			}
		});

		var player = document.getElementById('player');

		var handleSuccess = function(stream) {

            //acquire access to microphone
		    if (window.URL) {
		      player.src = window.URL.createObjectURL(stream);
		    } else {
		      player.src = stream;
		    }

            console.log('this is stream', stream)

            //access raw data from microphone
            var context = new AudioContext();
            var source = context.createMediaStreamSource(stream);

            // create a ScriptProcessorNode
            if(!context.createScriptProcessor){
               node = context.createJavaScriptNode(4096, 2, 2);
            } else {
               node = context.createScriptProcessor(4096, 2, 2);
            }

            // listen to the audio data, and record into the buffer
            node.onaudioprocess = function(e){
                // console.log(e.inputBuffer);
                recBuffersL.push(e.inputBuffer.getChannelData(0));
                recBuffersR.push(e.inputBuffer.getChannelData(1));
                recLength += e.inputBuffer.getChannelData(0).length;
            }

            // connect the ScriptProcessorNode with the input audio
            source.connect(node);
            // if the ScriptProcessorNode is not connected to an output 
            //the "onaudioprocess" event is not triggered in chrome
            node.connect(context.destination);

            console.log('this is context.d', context.destination);
            console.log('this is are node', node);

            var options = {mimeType: 'video/webm;codecs=vp9'};
            mediaRecorder = new MediaRecorder(stream, options);
            console.log(stream.getAudioTracks())
            mediaRecorder.ondataavailable = handleDataAvailable;
            mediaRecorder.start();
            console.log("mediarecorder", mediaRecorder)
		  };

		navigator.mediaDevices.getUserMedia({ audio: true, video: false })
		      .then(handleSuccess);


        function handleDataAvailable(event) {
            console.log("in handledataavail", event);
            console.log("input buffer", )
          if (event.data.size > 0) {
            //not sure which is more useful
            recordedChunks.push(event.data); //not working? 

            // recBuffersL.push(event.inputBuffer.getChannelData(0));
            // recBuffersR.push(event.inputBuffer.getChannelData(1));
          }
        }

        //plays concatenated audio snippets (useful for progress or feedback page)
        function play() {
          var superBuffer = new Blob(recordedChunks);
          videoElement.src =
            window.URL.createObjectURL(superBuffer);
        }

        //helper method downloads Blob to downloads
        //Q  -  how to pass back to Python script to store in SQL ? 
        function download() {
          var blob = new Blob(recordedChunks, {
            type: 'video/webm'
          });

          //send to flask via ajax request
          //jquery ajax post request to some route and in flask app, look for that 
          //jquery.post()
          //jquery.ajax() can handle post request (look at documentation) 

          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          document.body.appendChild(a);
          a.style = 'display: none';
          a.href = url;
          a.download = 'convo.webm';
          a.click();
          window.URL.revokeObjectURL(url);
        } 

		// var handleSuccess = function(stream) {
		//     var context = new AudioContext();
		//     var source = context.createMediaStreamSource(stream);
		//     var processor = context.createScriptProcessor(1024, 1, 1);
		//
		//     source.connect(processor);
		//     processor.connect(context.destination);
		//
		//     processor.onaudioprocess = function(e) {
		//       // Do something with the data, i.e Convert this to WAV
		//       // console.log(e.inputBuffer);
		// 			stream = new mediaStream();
		// 			track = stream.getAudioTracks()
		// 			console.log(track)
		//     };
		//   };
		//
		//   navigator.mediaDevices.getUserMedia({ audio: true, video: false })
		//       .then(handleSuccess);

	</script>

{% endblock %}
